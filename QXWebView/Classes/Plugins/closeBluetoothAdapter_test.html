<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>closeBluetoothAdapter 测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
        }
        .button:hover {
            background: #0056CC;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .log {
            background: #f8f8f8;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>uni.closeBluetoothAdapter 测试</h1>
        
        <div id="status" class="status info">
            状态：未初始化
        </div>
        
        <button id="initBtn" class="button">1. 初始化蓝牙</button>
        <button id="scanBtn" class="button" disabled>2. 开始扫描设备</button>
        <button id="stopScanBtn" class="button" disabled>3. 停止扫描</button>
        <button id="closeBtn" class="button" disabled>4. 关闭蓝牙适配器</button>
        <button id="clearLogBtn" class="button">清空日志</button>
        
        <h3>操作日志</h3>
        <div id="log" class="log"></div>
        
        <h3>测试场景</h3>
        <button id="testScenario1" class="button">场景1：完整流程测试</button>
        <button id="testScenario2" class="button">场景2：重复关闭测试</button>
        <button id="testScenario3" class="button">场景3：未初始化直接关闭</button>
    </div>

    <script>
        // 日志记录
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // 更新状态
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `状态：${message}`;
            statusDiv.className = `status ${type}`;
        }
        
        // 更新按钮状态
        function updateButtons(init = false, scan = false, stopScan = false, close = false) {
            document.getElementById('initBtn').disabled = !init;
            document.getElementById('scanBtn').disabled = !scan;
            document.getElementById('stopScanBtn').disabled = !stopScan;
            document.getElementById('closeBtn').disabled = !close;
        }
        
        // 检查 uni 对象是否存在
        function checkUniObject() {
            if (typeof uni === 'undefined') {
                log('错误：uni 对象不存在，请在支持的环境中运行', 'error');
                updateStatus('错误：环境不支持', 'error');
                return false;
            }
            return true;
        }
        
        // 1. 初始化蓝牙
        document.getElementById('initBtn').addEventListener('click', function() {
            if (!checkUniObject()) return;
            
            log('开始初始化蓝牙...');
            updateStatus('正在初始化...', 'info');
            
            uni.initBle({
                success: function(res) {
                    log(`蓝牙初始化成功: ${JSON.stringify(res)}`, 'success');
                    updateStatus('已初始化', 'success');
                    updateButtons(false, true, false, true);
                },
                fail: function(err) {
                    log(`蓝牙初始化失败: ${JSON.stringify(err)}`, 'error');
                    updateStatus('初始化失败', 'error');
                    updateButtons(true, false, false, false);
                },
                complete: function() {
                    log('蓝牙初始化操作完成');
                }
            });
        });
        
        // 2. 开始扫描
        document.getElementById('scanBtn').addEventListener('click', function() {
            if (!checkUniObject()) return;
            
            log('开始扫描蓝牙设备...');
            updateStatus('正在扫描...', 'info');
            
            uni.startBluetoothDevicesDiscovery({
                timeout: 10000,
                success: function(res) {
                    log(`开始扫描成功: ${JSON.stringify(res)}`, 'success');
                    updateButtons(false, false, true, true);
                },
                fail: function(err) {
                    log(`开始扫描失败: ${JSON.stringify(err)}`, 'error');
                    updateStatus('扫描失败', 'error');
                }
            });
        });
        
        // 3. 停止扫描
        document.getElementById('stopScanBtn').addEventListener('click', function() {
            if (!checkUniObject()) return;
            
            log('停止扫描蓝牙设备...');
            
            uni.stopBluetoothDevicesDiscovery({
                success: function(res) {
                    log(`停止扫描成功: ${JSON.stringify(res)}`, 'success');
                    updateStatus('扫描已停止', 'success');
                    updateButtons(false, true, false, true);
                },
                fail: function(err) {
                    log(`停止扫描失败: ${JSON.stringify(err)}`, 'error');
                }
            });
        });
        
        // 4. 关闭蓝牙适配器
        document.getElementById('closeBtn').addEventListener('click', function() {
            if (!checkUniObject()) return;
            
            log('关闭蓝牙适配器...');
            updateStatus('正在关闭...', 'info');
            
            uni.closeBluetoothAdapter({
                success: function(res) {
                    log(`蓝牙适配器关闭成功: ${JSON.stringify(res)}`, 'success');
                    updateStatus('已关闭', 'success');
                    updateButtons(true, false, false, false);
                },
                fail: function(err) {
                    log(`蓝牙适配器关闭失败: ${JSON.stringify(err)}`, 'error');
                    updateStatus('关闭失败', 'error');
                },
                complete: function() {
                    log('蓝牙适配器关闭操作完成');
                }
            });
        });
        
        // 清空日志
        document.getElementById('clearLogBtn').addEventListener('click', function() {
            document.getElementById('log').innerHTML = '';
        });
        
        // 测试场景1：完整流程测试
        document.getElementById('testScenario1').addEventListener('click', async function() {
            if (!checkUniObject()) return;
            
            log('=== 开始场景1：完整流程测试 ===', 'info');
            
            try {
                // 初始化
                await new Promise((resolve, reject) => {
                    uni.initBle({
                        success: resolve,
                        fail: reject
                    });
                });
                log('✓ 初始化成功', 'success');
                
                // 开始扫描
                await new Promise((resolve, reject) => {
                    uni.startBluetoothDevicesDiscovery({
                        timeout: 5000,
                        success: resolve,
                        fail: reject
                    });
                });
                log('✓ 扫描开始成功', 'success');
                
                // 等待2秒
                await new Promise(resolve => setTimeout(resolve, 2000));
                log('✓ 等待2秒完成', 'info');
                
                // 关闭适配器
                await new Promise((resolve, reject) => {
                    uni.closeBluetoothAdapter({
                        success: resolve,
                        fail: reject
                    });
                });
                log('✓ 蓝牙适配器关闭成功', 'success');
                
                log('=== 场景1测试完成 ===', 'success');
                updateStatus('场景1测试完成', 'success');
                updateButtons(true, false, false, false);
                
            } catch (error) {
                log(`✗ 场景1测试失败: ${JSON.stringify(error)}`, 'error');
                updateStatus('场景1测试失败', 'error');
            }
        });
        
        // 测试场景2：重复关闭测试
        document.getElementById('testScenario2').addEventListener('click', async function() {
            if (!checkUniObject()) return;
            
            log('=== 开始场景2：重复关闭测试 ===', 'info');
            
            try {
                // 第一次关闭
                await new Promise((resolve) => {
                    uni.closeBluetoothAdapter({
                        success: function(res) {
                            log('✓ 第一次关闭成功', 'success');
                            resolve(res);
                        },
                        fail: function(err) {
                            log('✓ 第一次关闭失败（预期）', 'info');
                            resolve(err);
                        }
                    });
                });
                
                // 第二次关闭
                await new Promise((resolve) => {
                    uni.closeBluetoothAdapter({
                        success: function(res) {
                            log('✓ 第二次关闭成功', 'success');
                            resolve(res);
                        },
                        fail: function(err) {
                            log('✓ 第二次关闭失败（预期）', 'info');
                            resolve(err);
                        }
                    });
                });
                
                log('=== 场景2测试完成 ===', 'success');
                updateStatus('场景2测试完成', 'success');
                
            } catch (error) {
                log(`✗ 场景2测试失败: ${JSON.stringify(error)}`, 'error');
                updateStatus('场景2测试失败', 'error');
            }
        });
        
        // 测试场景3：未初始化直接关闭
        document.getElementById('testScenario3').addEventListener('click', function() {
            if (!checkUniObject()) return;
            
            log('=== 开始场景3：未初始化直接关闭 ===', 'info');
            
            uni.closeBluetoothAdapter({
                success: function(res) {
                    log(`✓ 未初始化状态下关闭成功: ${JSON.stringify(res)}`, 'success');
                    log('=== 场景3测试完成 ===', 'success');
                    updateStatus('场景3测试完成', 'success');
                },
                fail: function(err) {
                    log(`✓ 未初始化状态下关闭失败（可能的预期结果）: ${JSON.stringify(err)}`, 'info');
                    log('=== 场景3测试完成 ===', 'info');
                    updateStatus('场景3测试完成', 'info');
                },
                complete: function() {
                    log('场景3操作完成');
                }
            });
        });
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('测试页面加载完成');
            updateStatus('未初始化', 'info');
            updateButtons(true, false, false, false);
            
            if (!checkUniObject()) {
                log('提示：请在支持 uni 对象的环境中运行此测试', 'info');
            }
        });
    </script>
</body>
</html>